org: aahmed31
app: serverless-bookquotes
service: serverless-bookquotes

frameworkVersion: '3'

custom:
  secrets: ${file(secrets.json)}
  slsLambdaRole: ${file(sls-lambda-role.json)}
  typesenseLambdaRole: ${file(typesense-lambda-role.json)}

provider:
  name: aws
  runtime: nodejs16.x
  stage: production
  region: us-east-2
  environment: # add environment property
    NODE_ENV: ${self:custom.secrets.NODE_ENV} 
    # reference the NODE_ENV from the secrets.json file
  # deploymentPrefix: ${service}
  # deploymentBucket: 
  #   name: book-quotes-sls
  #   blockPublicAccess: false
  #   versioning: false
  apiName: book-quotes-api
  endpointType: regional
  logs:
    restApi:
      level: INFO
  s3:
    bucketOne:
      name: book-quotes-sls
      versioningConfiguration:
        Status: Suspended

resources:
  Resources:
    quoteTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: quote-table
        AttributeDefinitions:
          - AttributeName: postId
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          - AttributeName: createdDate
            AttributeType: S
        KeySchema:
          - AttributeName: postId
            KeyType: HASH #partition key
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        GlobalSecondaryIndexes:
          - IndexName: createdDate-index
            KeySchema:
              - AttributeName: createdDate
                KeyType: HASH
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: '5'
              WriteCapacityUnits: '5'
          - IndexName: userId-index
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: '5'
              WriteCapacityUnits: '5'
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
    
    threadTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: thread-table
        AttributeDefinitions:
          - AttributeName: postId
            AttributeType: S
          - AttributeName: threadId
            AttributeType: S
        KeySchema:
          - AttributeName: threadId
            KeyType: HASH #partition key
        ProvisionedThroughput:
          ReadCapacityUnits: 5
          WriteCapacityUnits: 5
        GlobalSecondaryIndexes:
          - IndexName: postId-index
            KeySchema:
              - AttributeName: postId
                KeyType: HASH
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: '5'
              WriteCapacityUnits: '5'

functions:
  anyPath:
    handler: lambdas/any-lambda-index.handler # reference the file and exported method
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
      # arn:
      #   Fn::GetAtt: [ serverless-lambda-role, Arn ]
    events: # events trigger lambda functions
      - http: # this is an API Gateway HTTP event trigger
          path: /
          method: ANY
          cors: true
  proxyPath:
    handler: app.server # reference the file and exported method
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    events: # events trigger lambda functions
      - http: # all routes get proxied to the Express router
          path: /{proxy+}
          method: ANY
          cors: true
  healthCheck:              
    handler: lambdas/health-check-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    events:
      - http:
          path: /health
          method: GET
          cors: true
  quoteOps:  
    handler: lambdas/quote-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    # !GetAtt slsLambdaRoles.Arn
    events:
      - http: 
          path: /quote
          method: GET
          cors: true 
      - http:
          path: /quote
          method: POST
          cors: true
      - http:
          path: /quote
          method: PATCH
          cors: true
      - http:
          path: /quote
          method: DELETE
          cors: true
  quotesOps:  
    handler: lambdas/quote-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    events:
      - http: 
          path: /quotes
          method: GET
          cors: true 
  threadOps:  
    handler: lambdas/thread-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    events:
      - http: 
          path: /thread
          method: GET
          cors: true 
      - http: 
          path: /thread
          method: POST
          cors: true
      - http: 
          path: /thread
          method: PATCH
          cors: true
      - http: 
          path: /thread
          method: DELETE
          cors: true
  bookmarkOps:  
    handler: lambdas/bookmark-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsLambdaRoles
    events:
      - http: 
          path: /bookmark
          method: GET
          cors: true 
      - http: 
          path: /bookmark
          method: PUT
          cors: true
      - http: 
          path: /bookmark
          method: DELETE
          cors: true
  typesenselambda:
    handler: lambdas/typesense-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsTypesenseLambdaRole
    package:
      # Directories and files to include in the deployed package
      patterns:
        - '!**/*'
        - lambdas/node_modules/**
        - lambdas/typesense-lambda-index.js
        - lambdas/package-lock.json
        - lambdas/package.json
      # Explicitly set the package artifact to deploy (overrides native packaging behavior)
      artifact: lambdas/typesense-lambda.zip
      # Package this function as an individual artifact (default: false)
      individually: true
  dbTrigger:
    handler: lambdas/trigger-lambda-index.handler
    role: arn:aws:iam::341614884717:role/slsTypesenseLambdaRole
    # arn:aws:iam:us-east-2:341614884717:role/typesense-lambda-role
    events:
      # - stream: arn:aws:dynamodb::341614884717:table/quote-table/stream/2022-05-23T15:22:13.377
      - stream:
          type: dynamodb
          arn:
            Fn::GetAtt: [quoteTable, StreamArn]

